
<!doctype html>
<html lang="en">
<head>

	<meta charset="utf-8" />
	<link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
	<link rel="icon" type="image/png" href="../assets/img/favicon.png">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Assam Police</title>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />

	<!--     Fonts and icons     -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
	<link rel = "stylesheet" type = "text/css" href = "../assets/css/messagetab.css" />
	<!-- CSS Files -->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../assets/css/material-kit.css" rel="stylesheet"/>
    <script src="/socket.io/socket.io.js"></script>
  <style>

  #sidebar_secondary2{
    height: 400px;
  } 
  #commentdiv{
    margin-top: 20px;
  } 
  #commentdiv textarea{
    width: 225px;
  }
  .filenameclass a{
    font-size: 14px;
  }
  .avatar2{
    position: relative;
    top:-50px;
    margin-bottom: -50px;
  }
  .avatar2 li{
    background-color: #f3e5f5;
  }
  .frommsgs{
          max-width: 80%;
            position: absolute;
            left: 0px;
            padding: 10px;
            display: inline-block;
            border-radius: 10px;
            font-size: 18px;
            font-family: 'Barlow Condensed';
            font-weight: bold;
            background-color: #fafafa;
            color: #4d2600;
       }
       .tomsgs{
            position: absolute;
            right: 0px;
            padding: 10px;
            display: inline-block;
            border-radius: 10px;
            font-size: 18px;
            font-family: 'Barlow Condensed';
            font-weight: bold;
            background-color: #fbe9e7;
            color: #4d2600;
       }
       .tick {
       	margin-left: 10px;
       	float: right;
       }
       .timeDisp {
            color: #7e57c2;
            font-size: 10px;
        }
        #expiry {
        	height: 60px;
        }
        .avatar2 {
          margin-left: 200px;
        }
        </style>
</head>

<body class="profile-page">
	<nav class="navbar navbar-transparent navbar-fixed-top navbar-color-on-scroll">
    	<div class="container">
        	<!-- Brand and toggle get grouped for better mobile display -->
        	<div class="navbar-header">
        		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigation-example">
            		<span class="sr-only">Toggle navigation</span>
		            <span class="icon-bar"></span>
		            <span class="icon-bar"></span>
		            <span class="icon-bar"></span>
        		</button>
        
        	</div>

        			<div class="collapse navbar-collapse" id="navigation-example">
        				<ul class="nav navbar-nav navbar-center">
        				<!-- <form class="navbar-form navbar-center" method="post" action="/search" target="">
		      				<div class="form-group">
		        			<input type="text" id="query" autocomplete="false" class="form-control" placeholder="Search" name="search">
		         
		      				</div>
    					</form> -->
              <a href="/search"><i class="material-icons"  tooltip="Search">search</i></a>
    				</ul>
        				<ul class="nav navbar-nav navbar-right">
        				
        			 <li>
		            	<a class="btn btn-simple btn-white btn-just-icon" href="/home"><i class="material-icons"> home</i></a>
		            </li>
		             <li>
                    <button class="btn btn-simple btn-white btn-just-icon" data-toggle="modal" data-target="#mymessage"> 
              <i class="material-icons"> message</i>
                </li>
					 <li>
		                <a class="btn btn-simple btn-white btn-just-icon" href="/events" >
							<i class="material-icons">event</i>
						</a>
						
		            </li>
    				
		            <li>
                    <button class="btn btn-simple btn-white btn-just-icon" data-toggle="modal" data-target="#myemail"> 
              <i class="material-icons"> email</i>
                </li>
					 <li>
                <li>
                    <button class="btn btn-simple btn-white btn-just-icon" data-toggle="modal" data-target="#myModal"> 
              <i class="material-icons"> settings</i>
                </li>
		           
		            
        		</ul>
        	</div>
    	</div>
    </nav>

    <div class="wrapper">
		<div class="header header-filter" style="background-image: url('https://images.unsplash.com/photo-1423655156442-ccc11daa4e99?crop=entropy&dpr=2&fit=crop&fm=jpg&h=750&ixjsv=2.1.0&ixlib=rb-0.3.5&q=50&w=1450');"></div>

		<div class="main main-raised">
			<div class="profile-content">
	            <div class="container">
	                <div class="row">
                    <div class="col-md-2">
	                    <div class="profile">
	                        <div class="avatar">
	                         
	                        </div>
	                        <div class="name">
	                            <h3 class="title" id="name_put"></h3>
								<h6 id="designation_put"></h6>
								<h5 id="email_put"></h5>
	                        </div>
	                    </div>
	                
	                <div class="description text-center">
                        <p id="bio_put"> </p>
	                </div>
                  </div>
					
						<div class="col-md-8 ">
							<div class="profile">
			                    <div class="nav-align-center avatar2">
									<ul class="nav nav-pills" role="tablist">
								  <li class="active">
											<a href="#studio" role="tab" data-toggle="tab" >
												<i class="material-icons">mail</i>New mail</a>
									</li>
									<li>
				               <a href="#work" role="tab" data-toggle="tab">
												<i class="material-icons">drafts</i>In Process</a>
				          </li>
				          <li>
				              <a href="#shows" role="tab" data-toggle="tab">
												<i class="material-icons">done</i>Done</a>
				          </li>
                  <li>
                      <a href="#send_mail" role="tab" data-toggle="tab">
                        <i class="material-icons">near_me</i>Sent Mail</a>
                  </li>
				            </ul>

				                    <div class="tab-content gallery">
				                    	
										<div class="tab-pane active" id="studio">
											<ul class="pagination pagination-primary" id="toaddnewpage">

											</ul>
												<table class="table table-hover" >
													<thead>
														<th>Filename</th>
														<th>File Tag</th>
														<th>Comments</th>
														<th>Expiry Time</th>
														<th>From</th>
													</thead>
													<tbody id="newmail">
													</tbody>
												</table> 
				               </div>
				               <div class="tab-pane text-center" id="work">
				                  <ul class="pagination pagination-primary" id="toaddworkingpage">
                          </ul>
											<table class="table table-hover" >
													<thead>
														<th>Filename</th>
														<th>File Tag</th>
														<th>Comments</th>
														<th>Expiry Time</th>
														<th>From</th>
													</thead>
													<tbody id="workingmail">
													</tbody>
												</table> 
				                        </div>
										<div class="tab-pane text-center" id="shows">
											<ul class="pagination pagination-primary" id="toadddonemail">
												
											</ul>
											<table class="table table-hover" >
													<thead>
														<th>Filename</th>
														<th>File Tag</th>
														<th>Comments</th>
														<th>Expiry Time</th>
														<th>From</th>
													</thead>
													<tbody id="donemail">
													</tbody>
												</table> 
				                        </div>
                      <div class="tab-pane text-center" id="send_mail">
                      <ul class="pagination pagination-primary" id="toaddsendpage">

                      </ul>
                        <table class="table table-hover" >
                          <thead>
                            <th>Filename</th>
                            <th>File Tag</th>
                            <th>Comments</th>
                            <th>Expiry Time</th>
                            <th>To</th>
                            <th>Alert</th>
                          </thead>
                          <tbody id="sendmail">
                          </tbody>
                        </table> 
                                </div>

				          </div>
								</div>
							</div>
							<!-- End Profile Tabs -->
						</div>
	                </div>

	            </div>
	        </div>
		</div>

    </div>
<aside id="sidebar_secondary" class="tabbed_sidebar ng-scope chat_sidebar pull-left">

<div class="popup-head">
          <div class="popup-head-left pull-left"><a  target="_blank" >

<h1 id="nameto"></h1><small ><br> <span class="glyphicon glyphicon-briefcase" id="desto" aria-hidden="true"></span></small></a></div>
            <div class="popup-head-right pull-right">
                     
                        
            
            <button data-widget="remove" id="removeClass" class="chat-header-button pull-right" type="button"><i class="material-icons" >close</i></button>
                      </div>
</div>

<div id="chat" class="chat_box_wrapper chat_box_small chat_box_active  content-main"  style="opacity: 1; display: block; transform: translateX(0px);">
<div class="chat_box touchscroll chat_box_colors_a" id="past-msgs">
</div>
</div>
   
<form class="chat_submit_box" id="msgform">
    <div class="uk-input-group">
        <div  id="uploader1" class="fileupload msger">
        <input type="file" id="uploadimg" style="display: none;"/>
        <input type="button" value="Browse.." onclick="document.getElementById('uploadimg').click()" />
        </div>
       <input type="text" class="md-input" autocomplete="false" id="message" name="message" placeholder="Enter Your Message">
        

        <span style="vertical-align: sub" class="uk-input-group-addon">
        <button  id="sendmessage" name="sendmessage" class="chat-footer-button pull-right" type="submit"><i class="material-icons" >send</i></button>
        </span>
        
        
    </div>        
</form>
</aside>

<!-- /////////////////////////////////////////////////////////////////////////////////// -->
<aside id="sidebar_secondary2" class="tabbed_sidebar ng-scope chat_sidebar pull-left">

<div class="popup-head">
          <div class="popup-head-left pull-left"><a  target="_blank" >

<h1 id="nameto2"></h1><small ><br> <span class="glyphicon glyphicon-briefcase" id="desto2" aria-hidden="true"></span></small></a></div>
            <div class="popup-head-right pull-right">
                     
                        
            
            <button data-widget="remove" id="removeClass2" class="chat-header-button pull-right" type="button"><i class="material-icons" >close</i></button>
                      </div>
</div>

   
<form class="chat_submit_box" id="fileform">
  <div class="input-group">
    <span class="input-group-addon">
      <i class="material-icons">access_time</i>
    </span>
    <input required type="text" name="expiry" id="expiry" class="form-control" placeholder="Deadline">
  </div>

  <div class="input-group">
    <span class="input-group-addon">
      <i class="material-icons">label</i>
    </span>
    <input required type="text" name="tag" id="tag" class="form-control" placeholder="Tag">
  </div>
  <div class="input-group" id="commentdiv">
    <span class="input-group-addon">
      <i class="material-icons">short_text</i>
    </span>
    <textarea id="comment" name="comment" class="materialize-textarea"></textarea>
  </div>
    <div class="uk-input-group">

        <div  id="uploader1" class="fileupload msger">
        <input type="file" id="filesend" style="display: none;"/>
        <input type="button" value="Browse.." onclick="document.getElementById('filesend').click()" />
        </div>
        

        <span style="vertical-align: sub" class="uk-input-group-addon">
        <button  id="submit2" name="submit2" class="chat-footer-button pull-right" type="submit"><i class="material-icons" >send</i></button>
        </span>
        
        
    </div>        
</form>


<!-- <form class="fileform11"><div class="input-group"><span class="input-group-addon"><i class="material-icons">file upload</i></span><input type="file" id="filesend"/></div><p class="text-center"><button  class="btn btn-default btn-danger" data-dismiss="modal">Close</button><button name="submit" id="submit" class="btn btn-info btn-success">Send</button></p></form> -->


</aside>
<!-- ////////////////////////////////////////////////////////////////////////////////////////////// -->


<div id="emailmodal">
<!-- <div class="modal fade" id="myModal_102" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title text-center" id="myModalLabel">Send Files To Mohan (DSP)</h4></div><div class="modal-body"><form class="fileform11"><input type="hidden" id="userID" name="userID" value=101><div class="input-group"><span class="input-group-addon"><i class="material-icons">access_time</i></span><select name="expiry" id="expiry" multiple><option value="" disabled selected>Choose Number of Days:</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><select></div><div class="input-group"><span class="input-group-addon"><i class="material-icons">label</i></span><input required type="text" name="tag" id="tag" class="form-control" placeholder="Tag"></div><div class="input-group"><span class="input-group-addon"><i class="material-icons"></i></span><textarea id="comment" name="comment" class="materialize-textarea"></textarea></div><div class="input-group"><span class="input-group-addon"><i class="material-icons">file upload</i></span><input type="file" id="filesend" style="display: none;"/><input type="button" value="Browse.." onclick="document.getElementById('filesend').click()" /></div><p class="text-center"><button type="button" class="btn btn-default btn-danger" data-dismiss="modal">Close</button><button type="submit" name="submit" id="submit" class="btn btn-info btn-success">Send</button></p></form></div></div></div></div> -->
</div>

<div class="modal fade" id="myemail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
  <div class="modal-content">
    <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title text-center" id="myModalLabel">Friend list</h4>
    </div>
    <div class="modal-body">
      
                

                  <script type="text/javascript">
               
                var data = <%-JSON.stringify(allrows)%>;
                  
                  </script>
                  <div class="tim-row" id="tables-row">
        <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            
                            <th>Name</th>
                            <th class="text-center"> Designation</th>
                            <th class="text-right">Chat</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(var i=0; i<allrows.length; i++) { if(allrows[i].userID==row.userID)
                          continue;%>
                       <tr>
                         
                         <td >
                           <%= allrows[i].name %>
                         </td>
                          <td class="text-center">
                           <%= allrows[i].designation %>
                         </td>
                         
                         <td class="td-actions text-right">
                                <form >
                                  <input type="hidden" id="ID" name="ID" value=<%= allrows[i].userID %> >
                                  <button  id="addClass2" onclick='toggle1("<%=allrows[i].userID%>")' type="button" rel="tooltip"  class="my_g_class2">
                                    <i class="material-icons" >chat</i>

                                </button>
                                
                              </form>
                            </td>
                       </tr>
                    <% } %>
                    </tbody>
                </table>
                
                </div> 
             <!-- </div> -->
             <!--  <div class="tim-row" id="modal-row"> -->
                  <!-- Button trigger modal -->



               </div>
                

      
        
        
    </div>
  </div>
  </div>
</div>

       <div class="modal fade" id="mymessage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
  <div class="modal-content">
    <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title text-center" id="myModalLabel">Friend list</h4>
    </div>
    <div class="modal-body">
    	
                

                  <script type="text/javascript">
               
                var data = <%-JSON.stringify(allrows)%>;
                  
                  </script>
                  <div class="tim-row" id="tables-row">
        <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            
                            <th>Name</th>
                            <th class="text-center"> Designation</th>
                            <th class="text-right">Chat</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(var i=0; i<allrows.length; i++) { if(allrows[i].userID==row.userID)
                          continue;%>
                       <tr>
                         
                         <td >
                           <%= allrows[i].name %>
                         </td>
                          <td class="text-center">
                           <%= allrows[i].designation %>
                         </td>
                         
                         <td class="td-actions text-right">
                                <form >
                                  <input type="hidden" id="ID" name="ID" value=<%= allrows[i].userID %> >
                                  <button  id="addClass" onclick='toggle("<%=allrows[i].userID%>")' type="button" rel="tooltip"  class="my_g_class">
                                    <i class="material-icons" >chat</i>

                                </button>
                                
                              </form>
                            </td>
                       </tr>
                    <% } %>
                    </tbody>
                </table>
                
                </div> 
             <!-- </div> -->
             <!--  <div class="tim-row" id="modal-row"> -->
                  <!-- Button trigger modal -->



               </div>
                

      
        
        
    </div>
  </div>
  </div>
</div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
  <div class="modal-content">
    <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title text-center" id="myModalLabel">Update Profile</h4>
    </div>
    <div class="modal-body">
    <form action="/picchange" method="POST" encType="multipart/form-data" accept-charset="UTF-8">
          
           	<input type="hidden" id="userID" name="userID" value=<%= row.userID %>>
            <div class="input-group">
                    <span class="input-group-addon">
                      <i class="material-icons">face</i>
                    </span>
                    <input required type="text" name="user_name" id="user_name" class="form-control" placeholder="Name">
           </div>
           
           <div class="input-group">
                    <span class="input-group-addon">
                      <i class="material-icons">email</i>
                    </span>
                    <input required type="email" name="email" id="email" class="form-control" placeholder="E-mail">
           </div>
           <div class="input-group">
                    <span class="input-group-addon">
                      <i class="material-icons">phone</i>
                    </span>
                    <input required type="(?=.*\d).{10}" name="contact" id="contact" class="form-control" placeholder="Contact">
            </div>

           <div class="input-group">
                    <span class="input-group-addon">
                      <i class="material-icons">edit</i>
                    </span>
                    <input required type="text" name="bio" id="bio" class="form-control" placeholder="Something about you....">
            </div>
            <div class="input-group">
                     <span class="input-group-addon">
                      <i class="material-icons">file upload</i>
                    </span>
                     <input type="file" name="profilePicUpload" id="profilePicUpload" />
            </div>
            <p class="text-center"> 
      <button type="button" class="btn btn-default btn-danger" data-dismiss="modal">Close</button> 
    <button type="submit" name="adduser" id="submit" class="btn btn-info btn-success">Save</button>
   </p>
        </form>
    </div>
  </div>
  </div>
</div>

 
   




</body>
	<!--   Core JS Files   -->
	<script src="../assets/js/jquery.min.js" type="text/javascript"></script>
	<script src="../assets/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../assets/js/material.min.js"></script>

	<!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
	<script src="../assets/js/nouislider.min.js" type="text/javascript"></script>

	<!--  Plugin for the Datepicker, full documentation here: http://www.eyecon.ro/bootstrap-datepicker/ -->
	<script src="../assets/js/bootstrap-datepicker.js" type="text/javascript"></script>

	<!-- Control Center for Material Kit: activating the ripples, parallax effects, scripts from the example pages etc -->
	<script src="../assets/js/material-kit.js" type="text/javascript"></script>

</html>
<script type="text/javascript">
// Using jQuery.



function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
    vars[key] = value;
    });
    return vars;
}
  
    var rowVar = <%- JSON.stringify(row) %>;
    var filenameFull = <%- JSON.stringify(filenameFull) %>;
    console.log('<img alt="" src="images/profilePics/'+filenameFull+'">');
    $( ".avatar" ).html('<img alt="Circle Image" class="img-circle img-responsive img-raised" src="images/profilePics/'+filenameFull+'">');

    $( "#name_put" ).html("<b>"+rowVar.name+"</b>");
    $( "#email_put" ).html("<b>"+rowVar.email+"</b>");
     $( "#bio_put" ).html("<b>"+rowVar.bio+"</b>");
    $( "#designation_put" ).html("<b>"+rowVar.designation+"</b>");
   // $( "#station_put" ).html("<b>"+rowVar.station+"</b>");
    var vars = getUrlVars();
  
    //$( "div.all-contents" ).load("views/"+vars['page']+".html");
    

  </script>

  <script type="text/javascript">
var toRow = null;
var ddate = null;
var isimage = false;
var imgformats = ["jpg", "jpeg", "png", "bmp", "gif", "tiff","dds","psd","tif","svg"];
          var videoformats = ["ogv", "mp4", "wav", "avi", "mov", "mkv","3gp","flv","m4v","mpg","srt","swf","wmv","m4a"];
          var docformats = ["pdf", "txt", "dat","docx","doc","odf","xls","pdfs","rtf","tex","wpd","wks","ppt","xlsx","csv","html","pptx","tar","zip"];
var allrowVar = <%- JSON.stringify(allrows) %>;
var rowVar = <%- JSON.stringify(row) %>;
var msgVar = <%- JSON.stringify(allmsgs) %>;

var newmails = <%- JSON.stringify(newmails) %>;
var workingmails = <%- JSON.stringify(workingmails) %>;
var donemails = <%- JSON.stringify(donemails) %>;
var sendmails = <%- JSON.stringify(sendmails) %>;

function updateScroll(){
    var element = document.getElementsByClassName("content-main");
    element[0].scrollTop = element[0].scrollHeight;
}


function getRowById(allrowVar, userid){
     for(var i=allrowVar.length-1; i>=0; i--){
        if(allrowVar[i].userID == userid){
            toRow = allrowVar[i];
            break;
        }
     }
}

function getRowById2(userid){
	var allrowVar2 = <%- JSON.stringify(allrows) %>;
     for(var i=allrowVar2.length-1; i>=0; i--){
        if(allrowVar[i].userID == userid){
            return allrowVar2[i];
        }
     }
     return null;
}

function dateSQLToJS(datein){
    var tt = datein.split(/[- :]/);
    if(parseInt(tt[4])>=30){
        tt[3]=(parseInt(tt[3]) + 6) +"";
        tt[4]=""+((parseInt(tt[4])+30)%60);
    }else{
        tt[3]=(parseInt(tt[3])+5)+"";
        tt[4]=(parseInt(tt[4])+30)+"";
    }
    ddate = new Date(Date.UTC(tt[0], tt[1]-1, tt[2], tt[3], tt[4], tt[5]));
}

var numnewpages = Math.floor(newmails.length/10)+1;
var stringToAdd = '';
for(var j=0; j<numnewpages; j++){
	stringToAdd+='<li><a onclick="toggleNewMail('+(j+1)+')">'+(j+1)+'</a></li>';
}

$('#toaddnewpage').html(stringToAdd);

function toggleNewMail(data){
	var newmailstring = "";
	var start=newmails.length-(data-1)*10-1;
	var end=Math.max(newmails.length-(data)*10-1,0);
	var socket1 = io();
	var donewith = [];
	$('#newmail').html('');
	for(var i=start; i>=end; i--){
		donewith.push(newmails[i].id);
		console.log(JSON.stringify(newmails[i]));
		var $newRow = $('<tr id="newmail_'+i+'"></tr>');
		$newRow.append($('<td>').html('<a href="'+newmails[i].downloadlink+'" target="_blank">'+newmails[i].filename+'</a>'));
		$newRow.append($('<td>').html(newmails[i].filetag));
			$newRow.append($('<td>').html(newmails[i].comments));

			dateSQLToJS((newmails[i].expireTime).replace('T', ' ').replace('Z', ''));
	            var dateToPut = ddate.getDate() + "-"+(ddate.getMonth()+1)+"-"+ddate.getFullYear()+" "+ddate.getHours()+":"+ddate.getMinutes();

			$newRow.append($('<td>').html(dateToPut));
			$newRow.append($('<td>').html(getRowById2(newmails[i].fromID).name));
			$('#newmail').append($newRow);
	}
	socket1.emit('read mails', {donereading: donewith, fromRow: rowVar});

}
var numsendpages = Math.floor(sendmails.length/10)+1;
var stringToAdd = '';
for(var j=0; j<numsendpages; j++){
  stringToAdd+='<li><a onclick="togglesendMail('+(j+1)+')">'+(j+1)+'</a></li>';
}

$('#toaddsendpage').html(stringToAdd);

function togglesendMail(data){
  var sendmailstring = "";
  var start=sendmails.length-(data-1)*10-1;
  var end=Math.max(sendmails.length-(data)*10-1,0);
  $('#sendmail').html('');
  for(var i=start; i>=end; i--){
    console.log(JSON.stringify(sendmails[i]));
    var $sendRow = $('<tr id="sendmail_'+i+'"></tr>');
    $sendRow.append($('<td>').html('<a href="'+sendmails[i].downloadlink+'" target="_blank">'+sendmails[i].filename+'</a>'));
    $sendRow.append($('<td>').html(sendmails[i].filetag));
      $sendRow.append($('<td>').html(sendmails[i].comments));

      dateSQLToJS((sendmails[i].expireTime).replace('T', ' ').replace('Z', ''));
              var dateToPut = ddate.getDate() + "-"+(ddate.getMonth()+1)+"-"+ddate.getFullYear()+" "+ddate.getHours()+":"+ddate.getMinutes();


      $sendRow.append($('<td>').html(dateToPut));
      $sendRow.append($('<td>').html(getRowById2(sendmails[i].toID).name));
      if(sendmails[i].flag==1){
        $sendRow.append($('<td>').html('DONE!!')); 
      }else if(sendmails[i].flag==0 && ddate > new Date()){
        $sendRow.append($('<td>').html('PENDING!!!!')); 
      }else{
        $sendRow.append($('<td>').html('ALERT!!!!')); 
      }
      $('#sendmail').append($sendRow);
  }

}


var numworkingpages = Math.floor(workingmails.length/10)+1;
var stringToAdd = '';
for(var j=0; j<numworkingpages; j++){
	stringToAdd+='<li><a onclick="toggleWorkingMail('+(j+1)+')">'+(j+1)+'</a></li>';
}

$('#toaddworkingpage').html(stringToAdd);

function toggleWorkingMail(data){
	var workingmailstring = "";
	var start=workingmails.length-(data-1)*10-1;
	var end=Math.max(workingmails.length-(data)*10-1,0);
	$('#workingmail').html('');
	for(var i=start; i>=end; i--){
		console.log(JSON.stringify(workingmails[i]));
		var $workingRow = $('<tr id="workingmail_'+i+'"></tr>');
		$workingRow.append($('<td>').html('<a href="'+workingmails[i].downloadlink+'" target="_blank">'+workingmails[i].filename+'</a>'));
		$workingRow.append($('<td>').html(workingmails[i].filetag));
			$workingRow.append($('<td>').html(workingmails[i].comments));

			dateSQLToJS((workingmails[i].expireTime).replace('T', ' ').replace('Z', ''));
	            var dateToPut = ddate.getDate() + "-"+(ddate.getMonth()+1)+"-"+ddate.getFullYear()+" "+ddate.getHours()+":"+ddate.getMinutes();

			$workingRow.append($('<td>').html(dateToPut));
			$workingRow.append($('<td>').html(getRowById2(workingmails[i].fromID).name));
			$workingRow.append($('<td>').html('<a id ="check_'+workingmails[i].id+'" class="btn-floating btn-large waves-effect waves-light btn-danger" onclick="donewith('+workingmails[i].id+')"><i class="material-icons">beenhere</i></a>'));
			$('#workingmail').append($workingRow);
	}
}

function donewith(id){
  var socket2=io();
  $("#check_"+id).removeClass('btn-danger');
  $("#check_"+id).addClass('btn-success');
  socket2.emit('completed mail', {completed:id, fromRow: rowVar});
}

var numdonepages = Math.floor(workingmails.length/10)+1;
var stringToAdd = '';
for(var j=0; j<numdonepages; j++){
	stringToAdd+='<li><a onclick="toggleDoneMail('+(j+1)+')">'+(j+1)+'</a></li>';
}

$('#toadddonemail').html(stringToAdd);

function toggleDoneMail(data){
	var donegmailstring = "";
	var start=donemails.length-(data-1)*10-1;
	var end=Math.max(donemails.length-(data)*10-1,0);
	$('#donemail').html('');
	for(var i=start; i>=end; i--){
		console.log(JSON.stringify(donemails[i]));
		var $doneRow = $('<tr id="newmail_'+i+'"></tr>');
		$doneRow.append($('<td>').html('<a href="'+donemails[i].downloadlink+'" target="_blank">'+donemails[i].filename+'</a>'));
		$doneRow.append($('<td>').html(donemails[i].filetag));
			$doneRow.append($('<td>').html(donemails[i].comments));

			dateSQLToJS((donemails[i].expireTime).replace('T', ' ').replace('Z', ''));
	            var dateToPut = ddate.getDate() + "-"+(ddate.getMonth()+1)+"-"+ddate.getFullYear()+" "+ddate.getHours()+":"+ddate.getMinutes();

			$doneRow.append($('<td>').html(dateToPut));
			$doneRow.append($('<td>').html(getRowById2(donemails[i].fromID).name));
			$('#donemail').append($doneRow);
	}
}

// //////////////////////////////////////////////////////////////////////////////////////////////////
          function _arrayBufferToBase64( buffer ) {
                var binary = '';
                var bytes = new Uint8Array( buffer );
                var len = bytes.byteLength;
                for (var i = 0; i < len; i++) {
                    binary += String.fromCharCode( bytes[ i ] );
                }
                return window.btoa( binary );
            }
            function extractExtension(filename){
              var patt1 = /\.([0-9a-z]+)(?:[\?#]|$)/i;
                   var extension1 = (filename).match(patt1);
                   var extension = extension1[1];
                   return extension;
            }
          ////////////////////////////////////////////////////////////////////////////////////////////////////////



function createNewConversation(toRow1){
    $("#past-msgs").html("");
    var flag = 0;
    for(var i=0; i<msgVar.length; i++){
        if((msgVar[i].fromID == rowVar.userID && msgVar[i].toID == toRow1.userID)){
            dateSQLToJS((msgVar[i].timeOfMsg).replace('T', ' ').replace('Z', ''));
            var dateToPut = ddate.getDate() + "-"+(ddate.getMonth()+1)+"-"+ddate.getFullYear()+" "+ddate.getHours()+":"+ddate.getMinutes();
            if(msgVar[i].isImg==0){
                $('#past-msgs').append($('<div class="frommsgs">').html(msgVar[i].message+"<div class='timeDisp'>"+dateToPut +"<img class='tick' id='tick_"+i+"' src='' height=10 width=10></div>"));
                $('#past-msgs').append('<br><br><br>');
            }else{
                var whatisit = "";
                if(imgformats.indexOf(extractExtension(msgVar[i].imgname))>-1){
                    whatisit = "image";
                }else if(videoformats.indexOf(extractExtension(msgVar[i].imgname))>-1){
                    whatisit = "video";
                }else if(docformats.indexOf(extractExtension(msgVar[i].imgname))>-1){
                    whatisit = "docs";
                }else{
                    whatisit = "file";
                }
                if(whatisit=="image"){
                    $('#past-msgs').append($('<div class="frommsgs">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank"><img src="/images/tempfiles/'+msgVar[i].img+'" height="100px" width="100px" data-toggle="tooltip" title="'+msgVar[i].imgname+'" class="imgmsg">'+ "<div class='timeDisp'>"+dateToPut +"<img class='tick' id='tick_"+i+"' src='' height=10 width=10></div>"));
                    $('#past-msgs').append('<br><br><br><br><br><br><br>');
                }else if(whatisit=="video"){
                    $('#past-msgs').append($('<div class="frommsgs">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank"><video height="100px" width="100px" data-toggle="tooltip" title="'+msgVar[i].imgname+'"><source src="/images/tempfiles/'+msgVar[i].img+'" type="video/mp4"></video>'+ "<div class='timeDisp'>"+dateToPut +"<img class='tick' id='tick_"+i+"' src='' height=10 width=10></div>"));
                    $('#past-msgs').append('<br><br><br><br><br><br><br>');
                }else if(whatisit=="docs"){
                    $('#past-msgs').append($('<div class="frommsgs filenameclass">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank">'+msgVar[i].imgname+"<div class='timeDisp'>"+dateToPut +"<img class='tick' id='tick_"+i+"' src='' height=10 width=10></div>"));
                    $('#past-msgs').append('<br><br><br>');
                }else if(whatisit=="files"){
                    $('#past-msgs').append($('<div class="frommsgs filenameclass">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank">'+msgVar[i].imgname+"<div class='timeDisp'>"+dateToPut +"<img class='tick' id='tick_"+i+"' src='' height=10 width=10></div>"));
                    $('#past-msgs').append('<br><br><br>');
                }
            }
        }else if((msgVar[i].toID == rowVar.userID && msgVar[i].fromID == toRow1.userID)){
            dateSQLToJS((msgVar[i].timeOfMsg).replace('T', ' ').replace('Z', ''));
            var dateToPut = ddate.getDate() + "-"+(ddate.getMonth()+1)+"-"+ddate.getFullYear()+" "+ddate.getHours()+":"+ddate.getMinutes();
            if(msgVar[i].isImg==0){
                $('#past-msgs').append($('<div class="tomsgs">').html(msgVar[i].message+"<div class='timeDisp'>"+dateToPut +"</div>"));
                $('#past-msgs').append('<br><br><br>');
            }else{
                var whatisit = "";
                if(imgformats.indexOf(extractExtension(msgVar[i].imgname))>-1){
                    whatisit = "image";
                }else if(videoformats.indexOf(extractExtension(msgVar[i].imgname))>-1){
                    whatisit = "video";
                }else if(docformats.indexOf(extractExtension(msgVar[i].imgname))>-1){
                    whatisit = "docs";
                }else{
                    whatisit = "file";
                }
                if(whatisit=="image"){
                    $('#past-msgs').append($('<div class="tomsgs">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank"><img src="/images/tempfiles/'+msgVar[i].img+'" height="100px" width="100px" data-toggle="tooltip" title="'+msgVar[i].imgname+'" class="imgmsg"></a>'+ "<div class='timeDisp'>"+dateToPut +"</div>"));
                    $('#past-msgs').append('<br><br><br><br><br><br><br>');
                }else if(whatisit=="video"){
                    $('#past-msgs').append($('<div class="tomsgs">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank"><video height="100px" width="100px" data-toggle="tooltip" title="'+msgVar[i].imgname+'"><source src="/images/tempfiles/'+msgVar[i].img+'" type="video/mp4"></video></a>'+ "<div class='timeDisp'>"+dateToPut +"</div>"));
                    $('#past-msgs').append('<br><br><br><br><br><br><br>');
                }else if(whatisit=="docs"){
                    $('#past-msgs').append($('<div class="tomsgs filenameclass">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank">'+msgVar[i].imgname+"</a><div class='timeDisp'>"+dateToPut +"</div>"));
                    $('#past-msgs').append('<br><br><br>');
                }else if(whatisit=="files"){
                    $('#past-msgs').append($('<div class="tomsgs filenameclass">').html('<a href="/images/tempfiles/'+msgVar[i].img+'" target="_blank">'+msgVar[i].imgname+"</a><div class='timeDisp'>"+dateToPut +"</div>"));
                    $('#past-msgs').append('<br><br><br>');
                }
            }
        }
        if(msgVar[i].seen == 1 && flag == 0){
        	$('#tick_'+i).attr('src', '/images/double-tick.png');
        }else{
          console.log(">>>>>>>>>>>>>>>>HER$$$$$$$$$$$$$$$$$$$$$$$4E");
        	$('#tick_'+i).attr('src', '/images/tick.png');
        }
    }
    $('.imgmsg').hover(function(){
        $(this).css('z-index', '99');
        expander(this);
    }, function(){
        $(this).css('z-index', '-1');
        contracter(this);
    });
    updateScroll();
}
function expander(object){
    var maxw = object.naturalWidth;
    var tow = maxw;
    var toh = object.naturalHeight;
    var initRatio = tow/toh;
    if(maxw>700){
        tow = 700;
        toh = 700/initRatio;
    }
    object.height = toh;
    object.width = tow;
    }
    function contracter(object){
        object.height = 100;
        object.width = 100;
    }

     window.onload = function(){
        var filenameFull = <%- JSON.stringify(filenameFull) %>;
        $( ".avatar" ).html('<img alt="" src="images/profilePics/'+filenameFull+'">');

        $( "#name_put" ).html("<b>"+rowVar.name+"</b>");
        $( "#email_put" ).html("<b>"+rowVar.email+"</b>");
        $( "#designation_put" ).html("<b>"+rowVar.designation+"</b>");
        $( "#station_put" ).html("<b>"+rowVar.station+"</b>");
        var toInsert = "";
        
    }

    function toggle(userid){
      
        $("#message").removeAttr("disabled");
        if(toRow!=null){
            var previd = toRow.userID;
            $('#td'+previd).css("background-color", "#335577");
        }
        getRowById(allrowVar, userid);
        $('#nameto').text(toRow.name+","+toRow.designation);
        $('#desto').text(toRow.station+","+toRow.email);
        $('#td'+userid).css("background-color", "#113355");
        $.ajax({
           type: "POST",
           url: "/getmsgdata",
           data: {rowFrom: rowVar, rowTo: toRow},
           success: function(data){
             msgVar = (JSON.parse(data)).rows;
           }
         });
        if(toRow!=null)
            createNewConversation(toRow);
        var sock = io();
        sock.emit('seen', {frominfo: rowVar, toinfo: toRow});
    }




    function toggle1(userid){
    getRowById(allrowVar, userid);
    console.log("bkssnlll>>>>>>>>>>>>>");
        $('#nameto2').text(toRow.name+","+toRow.designation);
        $('#desto2').text(toRow.station+","+toRow.email);
    }
 //    for(var i=0; i<allrowVar.length - 1; i++){
 //    	var toPut1 = "";
 //    	toPut1+=toggle2(allrowVar[i].userID);
 //    	console.log(toPut1);
 //    	// document.getElementById('emailmodal').innerHTML = toPut1;
 //    }
 //    function toggle2(userid){
 //    	getRowById(allrowVar, userid);
 //    	var toPut = '<div class="modal fade" id="myModal_'+userid+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title text-center" id="myModalLabel">Send Files To '+toRow.name+' ('+toRow.designation+')</h4></div><div class="modal-body"><form id="fileform"><input type="hidden" id="userID" name="userID" value=<%= row.userID %>><div class="input-group"><span class="input-group-addon"><i class="material-icons">access_time</i></span><select name="expiry" id="expiry" multiple><option value="" disabled selected>Choose Number of Days:</option>';
	// 			      for(var i=1; i<30; i++){
	// 			      	toPut+='<option value="'+i+'">'+i+'</option>';
	// 			      }

	// 			      toPut+='<select></div><div class="input-group"><span class="input-group-addon"><i class="material-icons">label</i></span><input required type="text" name="tag" id="tag" class="form-control" placeholder="Tag"></div><div class="input-group"><span class="input-group-addon"><i class="material-icons"></i></span><textarea id="comment" name="comment" class="materialize-textarea"></textarea></div><div class="input-group"><span class="input-group-addon"><i class="material-icons">file upload</i></span><input type="file" id="filesend" style="display: none;"/><input type="button" value="Browse.." onclick="document.getElementById(\'filesend\').click()" /></div><p class="text-center"><button type="button" class="btn btn-default btn-danger" data-dismiss="modal">Close</button><button type="submit" name="submit" id="submit" class="btn btn-info btn-success">Send</button></p></form></div></div></div></div>';
	// // $('#emailmodal').html(toPut);
	// return toPut;
 //    }
    $('#sidebar_secondary').css('display', 'none');
    $(function () {
	      $(".my_g_class").click(function () {
	  			$('#sidebar_secondary').addClass('popup-box-on');
	    	});
	  
	    $("#removeClass").click(function () {
	  		$('#sidebar_secondary').removeClass('popup-box-on');
	    });
     });

    $('#sidebar_secondary2').css('display', 'none');
    $(function () {
        $(".my_g_class2").click(function () {
          $('#sidebar_secondary2').addClass('popup-box-on');
        });
    
      $("#removeClass2").click(function () {
        $('#sidebar_secondary2').removeClass('popup-box-on');
      });

     });
    $("#submit2").click(function () {
        $('#sidebar_secondary2').removeClass('popup-box-on');
      });

    var socket = io();

     $('#fileform').submit(function(){
     	// alert("SADSAD");
			  	console.log("HERER>>>>>>>>>>>>>>.");
          if(toRow!=null){
			  	var reader = new FileReader();
              reader.onload = function() {
                var arrayBuffer = this.result;
	          	socket.emit('file message', {buffer: arrayBuffer, downloadlink: "", dateToInsert: "", filename: document.getElementById('filesend').files[0].name, toinfo: toRow, frominfo: rowVar, timeOfMsg:  (new Date()).getDate() + "-"+((new Date()).getMonth()+1)+"-"+(new Date()).getFullYear()+" "+(new Date()).getHours()+":"+(new Date()).getMinutes(), tag: $('#tag').val(), comment: $('#comment').val(), expiry: $('#expiry').val()});
	          	}
              reader.readAsArrayBuffer(document.getElementById('filesend').files[0]);
            }
            return false;
  	});


          $('#msgform').submit(function(){
            if(toRow!=null){
                if(!isimage){
                    socket.emit('_chat', {image: false, message: $('#message').val(), toinfo: toRow, frominfo: rowVar, timeOfMsg:  (new Date()).getDate() + "-"+((new Date()).getMonth()+1)+"-"+(new Date()).getFullYear()+" "+(new Date()).getHours()+":"+(new Date()).getMinutes()});
                    $('#message').val('');
                    return false;
                }else{
                    var reader = new FileReader();
                      reader.onload = function() {
                        var arrayBuffer = this.result;
                          socket.emit('_chat', {image: true, buffer: arrayBuffer, dateToInsert: "", filename: document.getElementById('uploadimg').files[0].name, message: '', toinfo: toRow, frominfo: rowVar, timeOfMsg:  (new Date()).getDate() + "-"+((new Date()).getMonth()+1)+"-"+(new Date()).getFullYear()+" "+(new Date()).getHours()+":"+(new Date()).getMinutes()});
                      }
                      reader.readAsArrayBuffer(document.getElementById('uploadimg').files[0]);
                    $('#message').val('');
                    isimage = false;
                    return false;
                }
            }
          });
          socket.on('seen', function(msg){
          	if(msg.toinfo.userID == rowVar.userID){
          		$('.tick1').each(function(){
          			$(this).attr('src','/images/double-tick.png');
          		});
          	}
          });
          
          socket.on('_chat', function(msg){
            if(msg.image){
                var whatisit = "";
                if(imgformats.indexOf(extractExtension(msg.filename))>-1){
                    whatisit = "image";
                }else if(videoformats.indexOf(extractExtension(msg.filename))>-1){
                    whatisit = "video";
                }else if(docformats.indexOf(extractExtension(msg.filename))>-1){
                    whatisit = "docs";
                }else{
                    whatisit = "file";
                }
                var storeFilename = msg.frominfo.userID+'_'+msg.toinfo.userID+'_'+(msg.dateToInsert).replace(' ','-')+'.'+extractExtension(msg.filename);
                if(msg.frominfo.userID == rowVar.userID){
                    if(whatisit == "image"){
                        $('#past-msgs').append($('<div class="frommsgs">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank"><img src="data:image/jpeg;base64, '+_arrayBufferToBase64(msg.buffer)+'" height="100px" width="100px" alt="'+msg.filename+'" class="imgmsg"></a>'+ "<div class='timeDisp'>"+msg.timeOfMsg +"<img class='tick1' src='/images/tick.png' height=10 width=10></div>"));
                        $('#past-msgs').append('<br><br><br><br><br><br><br>');
                    }else if(whatisit=="video"){
                        $('#past-msgs').append($('<div class="frommsgs">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank"><iframe src="/images/tempfiles/'+storeFilename+'" height="100px" width="100px" alt="'+msg.filename+'"></a>'+ "<div class='timeDisp'>"+msg.timeOfMsg +"<img class='tick1' src='/images/tick.png' height=10 width=10></div>"));
                        $('#past-msgs').append('<br><br><br><br><br><br><br>');
                    }else if(whatisit == "docs"){
                        $('#past-msgs').append($('<div class="frommsgs filenameclass">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank">'+msg.filename+"</a><div class='timeDisp'>"+msg.timeOfMsg +"<img class='tick1' src='/images/tick.png' height=10 width=10></div>"));
                        $('#past-msgs').append('<br><br><br>');
                    }else if(whatisit == "file"){
                        $('#past-msgs').append($('<div class="frommsgs filenameclass">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank">'+msg.filename+"</a><div class='timeDisp'>"+msg.timeOfMsg +"<img class='tick1' src='/images/tick.png' height=10 width=10></div>"));
                        $('#past-msgs').append('<br><br><br>');
                    }
                }
                if(msg.toinfo.userID == rowVar.userID){
                    if(whatisit == "image"){
                        $('#past-msgs').append($('<div class="tomsgs">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank"><img src="data:image/jpeg;base64, '+_arrayBufferToBase64(msg.buffer)+'" height="100px" width="100px" alt="'+msg.filename+'" class="imgmsg"></a>'+ "<div class='timeDisp'>"+msg.timeOfMsg +"</div>"));
                        $('#past-msgs').append('<br><br><br><br><br><br><br>');
                    }else if(whatisit=="video"){
                        $('#past-msgs').append($('<div class="tomsgs">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank"><iframe src="/images/tempfiles/'+storeFilename+'" height="100px" width="100px" alt="'+msg.filename+'"></a>'+ "<div class='timeDisp'>"+msg.timeOfMsg +"</div>"));
                        $('#past-msgs').append('<br><br><br><br><br><br><br>');
                    }else if(whatisit == "docs"){
                        $('#past-msgs').append($('<div class="tomsgs filenameclass">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank">'+msg.filename+"</a><div class='timeDisp'>"+msg.timeOfMsg +"</div>"));
                        $('#past-msgs').append('<br><br><br>');
                    }else if(whatisit == "file"){
                        $('#past-msgs').append($('<div class="tomsgs filenameclass">').html('<a href="/images/tempfiles/'+storeFilename+'" target="_blank">'+msg.filename+"</a><div class='timeDisp'>"+msg.timeOfMsg +"</div>"));
                        $('#past-msgs').append('<br><br><br>');
                    }
                }
            }
            else{ 
                if(msg.toinfo.userID == rowVar.userID){
                    $('#past-msgs').append($('<div class="tomsgs">').html(msg.message + "<div class='timeDisp'>"+msg.timeOfMsg +"</div>"));
                    $('#past-msgs').append('<br><br><br>');
                }
                if(msg.frominfo.userID == rowVar.userID){
                    $('#past-msgs').append($('<div class="frommsgs">').html(msg.message + "<div class='timeDisp'>"+msg.timeOfMsg +"<img class='tick1' src='/images/tick.png' height=10 width=10></div>"));
                    $('#past-msgs').append('<br><br><br>');
                }
            }
            $('.imgmsg').hover(function(){
                $(this).css('z-index', '99');
                expander(this);
            }, function(){
                $(this).css('z-index', '-1');
                contracter(this);
            });
            updateScroll();
         
        });
    $('#uploader1').click(function(){
        isimage = true;
    });



</script>
